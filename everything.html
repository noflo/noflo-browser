<!DOCTYPE html>
<html manifest="/noflo-browser/manifest.appcache">
  <head>
    <meta charset="utf-8">
    <title>everything</title>
    <script src="http://cdn.rawgit.com/rtc-io/rtc/v3.1.1/dist/rtc.js"></script>
    <script src="everything.js"></script>
    <style>
    #flowhub_debug_url.nodebug {
      display: none;
    }
    #flowhub_debug_url.debug {
      display: inherit;
    }
    </style>
    
        <style>
body {
  padding: 0px;
  margin: 0px;
  color: #ffffff;
}
</style>
    
        <script>
requirejs.config({
  packages: [
    {
      name: 'React',
      location: './bower_components/react',
      main: 'react'
    }
  ]
});
</script>
    
  </head>
  <body>
    <a id='flowhub_debug_url' target="_blank" class='nodebug'>Debug in Flowhub</a>
    <!-- default -->
    <script>
      var noflo = require('noflo');

      function getParameterByName(name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        var regex = new RegExp("[\\?&]" + name + "=([^&#]*)");
        var results = regex.exec(location.search);
        return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
      }

      noflo.graph.loadJSON(require('noflo-browser-everything/graphs/everything.json'), function (graph) {
        graph.baseDir = '/noflo-browser-everything';

        var queryProtocol = getParameterByName('fbp_protocol');
        var queryAddress = getParameterByName('fbp_address');
        var queryNoLoad = getParameterByName('fbp_noload');

        var runtimeOptions = {
            baseDir: graph.baseDir
        };
        if (queryNoLoad.toLowerCase() !== 'true') {
            runtimeOptions.defaultGraph = graph;
        };
        if (!queryProtocol) {
            queryProtocol = 'webrtc';
        }

        var rt = null;
        if (queryProtocol == 'webrtc') {
          var webrtcRuntime = require('noflo-runtime-webrtc');
          if (queryAddress) {
            // ID to use specified from outside, normally by Flowhub IDE
            rt = webrtcRuntime(queryAddress, runtimeOptions, true);
          } else {
            // Generate new ID
            rt = webrtcRuntime(null, runtimeOptions, true);
            rt.signaller = 'https://api.flowhub.io';
          }
          var ide = 'https://app.flowhub.io';
          var debugUrl = ide+'#runtime/endpoint?'+encodeURIComponent('protocol=webrtc&address='+rt.signaller+'#'+rt.id);
          var debugButton = document.getElementById('flowhub_debug_url');
          console.log('Debug URL', debugUrl);
          debugButton.className = "debug";
          debugButton.href = debugUrl;
        } else if (queryProtocol == 'iframe') {
          var iframeRuntime = require('noflo-runtime-iframe');
          rt = iframeRuntime(runtimeOptions);
        }

        if (rt) {
          rt.network.on('addnetwork', function () {
            console.log('everything is running!');
          });
          rt.start();
        } else {
          console.log('Warning: unable to create FBP runtime');
        }
      });
    </script>
  </body>
</html>
